# ====================
# STAGE 1: Dependencies
# ====================
FROM node:18-alpine AS deps

WORKDIR /app

# Instalar depend√™ncias de build
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    openssl-dev

# Copiar apenas os arquivos necess√°rios para instala√ß√£o
COPY package.json package-lock.json* ./

# Instalar depend√™ncias de produ√ß√£o
RUN npm ci --only=production --ignore-scripts

# ====================
# STAGE 2: Builder
# ====================
FROM node:18-alpine AS builder

WORKDIR /app

# Copiar node_modules da stage deps
COPY --from=deps /app/node_modules ./node_modules

# Copiar c√≥digo fonte
COPY . .

# Verificar e limpar arquivos desnecess√°rios
RUN rm -rf \
    node_modules/.cache \
    *.log \
    *.md \
    .gitignore \
    .eslintrc.js \
    .prettierrc \
    jest.config.js \
    && find . -name "*.test.js" -delete \
    && find . -name "*.spec.js" -delete \
    && find . -name "__tests__" -type d -exec rm -rf {} +

# ====================
# STAGE 3: Production
# ====================
FROM node:18-alpine

# Metadados
LABEL maintainer="BizFlow Team <suporte@bizflow.com>"
LABEL version="1.0.0"
LABEL description="BizFlow Backend API"

# Argumentos
ARG NODE_ENV=production
ARG PORT=3000

# Vari√°veis de ambiente
ENV NODE_ENV=${NODE_ENV} \
    PORT=${PORT} \
    TZ=America/Sao_Paulo \
    NODE_OPTIONS="--max-old-space-size=512 --enable-source-maps" \
    NPM_CONFIG_PRODUCTION=true \
    NPM_CONFIG_LOGLEVEL=error \
    NPM_CONFIG_UPDATE_NOTIFIER=false \
    NPM_CONFIG_AUDIT=false \
    NPM_CONFIG_FUND=false

WORKDIR /app

# Instalar curl para health checks e tzdata para timezone
RUN apk add --no-cache \
    tzdata \
    curl \
    && cp /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime \
    && echo "America/Sao_Paulo" > /etc/timezone \
    && apk del tzdata \
    && rm -rf /var/cache/apk/*

# Criar usu√°rio n√£o-root com permiss√µes espec√≠ficas
RUN addgroup -g 1001 -S nodejs \
    && adduser -S nodejs -u 1001 \
    && mkdir -p /app/uploads /app/logs /app/temp \
    && chown -R nodejs:nodejs /app

# Copiar apenas os arquivos necess√°rios
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/package*.json ./
COPY --from=builder --chown=nodejs:nodejs /app/src ./src
COPY --from=builder --chown=nodejs:nodejs /app/server.js ./
COPY --from=builder --chown=nodejs:nodejs /app/.env.example ./
COPY --from=builder --chown=nodejs:nodejs /app/migrations ./migrations
COPY --from=builder --chown=nodejs:nodejs /app/seeds ./seeds

# Configurar permiss√µes
RUN chmod -R 755 /app/src \
    && chmod 644 /app/.env.example \
    && chown -R nodejs:nodejs /app/uploads /app/logs /app/temp

# Mudar para usu√°rio n√£o-root
USER nodejs

# Verificar estrutura final
RUN echo "‚úÖ Estrutura final do projeto:" && ls -la && \
    echo "‚úÖ Tamanho do node_modules:" && du -sh node_modules/ && \
    echo "‚úÖ Vers√£o do Node.js:" && node --version && \
    echo "‚úÖ Vers√£o do NPM:" && npm --version

# Expor porta
EXPOSE ${PORT}

# Health check avan√ßado
HEALTHCHECK --interval=30s \
            --timeout=10s \
            --start-period=40s \
            --retries=3 \
            CMD curl -f http://localhost:${PORT}/health || \
                curl -f http://localhost:${PORT}/live || \
                exit 1

# Labels para monitoramento
LABEL healthcheck.interval="30s"
LABEL healthcheck.timeout="10s"
LABEL healthcheck.retries="3"

# Comando de inicializa√ß√£o com tratamento de erros
CMD ["sh", "-c", "echo 'üöÄ Iniciando BizFlow Backend...' && \
     echo 'üìÖ Timezone: $TZ' && \
     echo 'üåç Ambiente: $NODE_ENV' && \
     echo 'üîß Node Options: $NODE_OPTIONS' && \
     node server.js"]
